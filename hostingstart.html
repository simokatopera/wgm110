<!DOCTYPE html>

<html lang="fi">
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
<!-- this makes JSON to be found on IE9 -->
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- ================================ -->



  <title>AzureTool</title>

<style>
  body {
    background-color:lightgreen; 
  }
  h1 {
    color:blue;
  }
  #msg { 
    color:red; 
  }

  #customerData thead { 
    background-color:blue; 
    color:white; 
  }
  #customerData tbody{ 
    background-color:lightblue; 
    color:blue;
  }
  button {
    background-color:blue;
    color:white;
  }
  fieldset {
    background-color:lightblue;
  }

</style>
</head>
<!-- ================================ -->
 
<body>
  <h1> Azure Tool for Reading Temperature DB</h1>
    
  <form id="azureForm" onsubmit="return false;">
     <table>
     <tr>
     <td>Give dates in format:<td> ddmmyyyy
     <tr>
     <td>Start date:<td><input type="numbers" id="inputStartDate" size="10" maxlength="10" name="inputStartDate">
     <tr>
     <td>End date:<td><input type="numbers" id="inputEndDate" size="10" maxlength="10" name="inputEndDate">
     <tr>
     <tr>
     <td><button id="getDataFromHub" onclick="Funct_getDataFromHub()">Get Data for Selected Day(s)</button>
     <td><button id="getDataCountSel" onclick="Funct_getDataCount(1)">  Get Data Count for Selected Day(s)</button>
     <tr>
     <td><button id="getDataCountAll" onclick="Funct_getDataCount(0)">  Get Line Count in Database</button>
     <tr>
     <td><button id="getLatestData" onclick="Funct_getLatestData()">  Get Latest 50 Lines</button>
     <tr>
     <td><button id="getCustomerInfo" onclick="Funct_getCustomerInfo()">  Get Customers</button>
     </table>
  </form>
  <div id="msg"></div><br>
  <div id="debugMsg"></div>
  <br>
  <form id="userEditForm" onSubmit="return false;">
   <fieldset>
    <table>
    <tr>
    <td>Customer Id:<td><input  type="text" id="modifyCustomerId" size="30" maxlength="30" name="modifyCustomerId" readonly>
    <tr>
    <td>Customer Name:<td><input  type="text" id="modifyCustomerName" size="30" maxlength="30" name="modifyCustomerName">
    <tr>
    <td>Street Address:<td><input  type="text" id="modifyCustomerStreetAddress" size="30" maxlength="30" name="modifyCustomerStreetAddress">
    <tr>
    <td>Devicelist:<td><input  type="text" id="modifyCustomerDevices" size="30" maxlength="30" name="modifyCustomerDevices">
    <tr>
    <td>Telephone:<td><input  type="text" id="modifyCustomerTelephone" size="30" maxlength="30" name="modifyCustomerTelephone">
    <tr>
    <td>Email:<td><input  type="text" id="modifyCustomerEmail" size="30" maxlength="30" name="modifyCustomerEmail">
    <tr>
    <tr>
    <td><button id="saveChanges" onclick="Funct_saveChanges()">Save Changes</button>
    </table>
   </fieldset>
  </form>
  <br>
  
  <button id="addCustomer" onclick="Funct_addCustomer()">Add New Customer</button>
 
  <table id="customerData" border="1"> </table>
  
<script>
  var USE_PHP = false;
  
  var showSentMsg = true;
  
  var collectData = false;
  var savedData = null;
  var xmlhttp;
  
  window.onload = function () {
    hideUserEditForm();
    hideAddNewNewCustomer();
    var today = new Date();
    var dateStr = '';
    if (today.getDate() < 10) dateStr += '0';
    dateStr += today.getDate();
    if (today.getMonth() + 1 < 10) dateStr += '0';
    dateStr += (today.getMonth() + 1).toString() + today.getFullYear().toString();
    
    setStartDate(dateStr);
    setEndDate(dateStr);
    wakeupFunction();
    //setStartDate('20042016');
    //setEndDate('20042016');
  }
  
  function hideUserEditForm() {
    document.getElementById("userEditForm").style.display = "none";
  }
  function showUserEditForm(cells) {
    document.forms.userEditForm.modifyCustomerId.value = cells[2].innerText;
    document.forms.userEditForm.modifyCustomerName.value = cells[3].innerText;
    document.forms.userEditForm.modifyCustomerStreetAddress.value = cells[4].innerText;
    document.forms.userEditForm.modifyCustomerDevices.value = cells[5].innerText;
    document.getElementById("userEditForm").style.display = "";
  }
  function hideAddNewNewCustomer() {
    document.getElementById('addCustomer').style.display = 'none';
  }
  function showAddNewNewCustomer() {
    document.getElementById('addCustomer').style.display = '';
  }
  function clearMessage() {
    // clears the notice message
    showMessage('');
  }
  function showCommand(msg) {
    // sets notice message
	//document.getElementById('debugMsg').innerText = msg;
  }
  function showMessage( msg) {
    // sets notice message
	document.getElementById('msg').innerText = msg;
  }
  
  function isNumeric(val) {
    return Number(parseFloat(val))==val;
  }
  
  function isValidDate(d) {
  var status = 0;
    if (d.length == 8) {
      if (isNaN(d) == false) {
        // all numbers
        var day = Number(d.substring(0,2));
        var month = Number(d.substring(2,4) - 1);
        var year = Number(d.substring(4,8));
        var date = new Date(year, month, day);
        if (!isNaN(date)) {
          var d = date.getDate();
          var m = date.getMonth();
          var y = date.getFullYear();
          if (date.getMonth() == month && date.getDate() == day && date.getFullYear() == year) {
            status = date.getTime();
          }
        }
      }
    }
    return status;
  }
  
  function setStartDate(date) {
    document.forms.azureForm.inputStartDate.value = date;
  }
  
  function setEndDate(date) {
    document.forms.azureForm.inputEndDate.value = date;
  }
  
  function getDates() {
    var startDate = document.forms.azureForm.inputStartDate.value.trim();
    var endDate = document.forms.azureForm.inputEndDate.value.trim();
    var datesOk = false;
    var sDateMs = isValidDate(startDate);
    var eDateMs = 0;
    if (sDateMs > 0){
      eDateMs = isValidDate(endDate);
      eDateMs += 1000.0 * 3600 * 24;
      if (eDateMs > sDateMs) {
        datesOk = true;
      }
    }
    return ({status:datesOk,startDate:sDateMs, endDate:eDateMs});
  }
  
  function Funct_getDataFromHub() {
    clearMessage();
    hideUserEditForm();
    hideAddNewNewCustomer();
    var d = getDates();
    
    if (d.status == true) {
      // clear customer data from table
      var table = document.getElementById('customerData');
      var requestMsg = 'index' + '?start=' + d.startDate + '&end=' + d.endDate + '&rnd=' + Math.random();
      while (table.rows.length > 0) {
        table.deleteRow(0);
      }      
	  if (USE_PHP) {
	    var requestMessage = '';
        requestMsg = 'azureServer.php?command=index' + '&start=' + d.startDate + '&end=' + d.endDate + '&rnd=' + Math.random();
        xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
            var jsonData = null;
            if (xmlhttp.readyState == 4) {
              if (xmlhttp.status == 200) {
                showMessage(xmlhttp.responseText);
              }
            }
        };
        if (showSentMsg) showCommand(requestMsg);
        xmlhttp.open("GET", requestMsg, true);
        xmlhttp.send();	  
	  }else {
        xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = callbackGetData;
        if (showSentMsg) showCommand(requestMsg);
        xmlhttp.open("GET", requestMsg, true);
        xmlhttp.send();
	  }
      }else {
      showMessage('Invalid dates given!');
    }
  }

  function callbackGetData() {
    if (xmlhttp.readyState == 4) {
      if(xmlhttp.status == 200) {
        var data = JSON.parse(xmlhttp.responseText);
        if (data.length > 1) {
          if (data[0].MaxCount < data.length) {
            showMessage('Only first ' + data[0].MaxCount + ' lines returned');
          }
          else {
            showMessage(data.length - 1 + ' lines returned!');
          }
          
          var table = document.getElementById('customerData');
          var rowNo = 0;
        
          var d = data[1];
          var keys = Object.keys(d);

          var header = table.createTHead();
          var hr = header.insertRow(0);
          hr.insertCell(0);
          for (var i = 0; i < keys.length;i++) {
            var hc = hr.insertCell(i + 1);
            hc.innerText = keys[i];
          }
          var body = table.createTBody();
          for (var index = 1; index < data.length; index++) {
            var row = body.insertRow(rowNo);
            var cell;
            var dataItem = data[index];
            var fieldNo = 0;
            cell = row.insertCell(0);
            cell.innerText = index;
            for (var key in d) {
              cell = row.insertCell(fieldNo + 1);
              if (dataItem[key] === null) {
                cell.innerText = 'NaN';
              } else {
                if (dataItem[key].type == 'Buffer')
                {
                  var te = '';
                  for (var k = 0; k < dataItem[key].data.length; k++) {
                    if (k > 0) te += ',';
                    te = te + dataItem[key].data[k];
                  }
                  cell.innerText = te;
                } else {
                  if (keys[fieldNo] == 'Time') {
                    var dt = new Date(dataItem[key])
                    cell.innerText = dt;
                  } else {
                    cell.innerText = dataItem[key];
                  }
                }
              }
              fieldNo++;
            }
            rowNo++;
          }
          if (collectData) {
            collectData = false;
            savedData = data;
            addRowHandlersToTable('customerData');
          }
          else savedData = null;
        } else {
           showMessage('Empty data received');
        }
      }
    }
  }   
var countMode = 0;  
  function Funct_getDataCount(mode) {
    countMode = mode;
    clearMessage();
    hideUserEditForm();
    var d = getDates();

     if (USE_PHP) {
	    //ar requestMessage = '';
        //requestMsg = 'azureServer.php?command=index' + '&start=' + d.startDate + '&end=' + d.endDate + '&rnd=' + Math.random();
        var requestMsg = 'azureServer.php?command=count' + '&rnd=' + Math.random();
        if (mode != 0 && d.status == true){
          requestMsg = 'azureServer.php?command=count' + '&start=' + d.startDate + '&end=' + d.endDate + '&rnd=' + Math.random();
        }
        xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
            var jsonData = null;
            if (xmlhttp.readyState == 4) {
              if (xmlhttp.status == 200) {
                showMessage(xmlhttp.responseText);
              }
            }
        };
        if (showSentMsg) showCommand(requestMsg);
        xmlhttp.open("GET", requestMsg, true);
        xmlhttp.send();	  
	  
	}else {
      var requestMsg = 'count' + '?rnd=' + Math.random();
      if (mode != 0 && d.status == true){
        requestMsg = 'count' + '?start=' + d.startDate + '&end=' + d.endDate + '&rnd=' + Math.random();
      }
      //showMessage(requestMsg);
      xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = callbackGetCount;
      if (showSentMsg) showCommand(requestMsg);
      xmlhttp.open("GET", requestMsg, true);
      xmlhttp.send();
	}
  }
 
  function callbackGetCount() {
    if (xmlhttp.readyState == 4) {
      if(xmlhttp.status == 200) {
        var data = JSON.parse(xmlhttp.responseText);
        if (countMode == 0) {
          showMessage('Records in database:' + data.Linecount);
        } else {
          showMessage('Records in given date range:' + data.Linecount);
        }
      }
    }
  }    
  
  function Funct_getLatestData() {
    clearMessage();
    hideUserEditForm();
    hideAddNewNewCustomer();
    var d = {status : true, startDate : 0, endDate : 0};
    
    if (d.status == true) {
      // clear customer data from table
      var table = document.getElementById('customerData');
      while (table.rows.length > 0) {
        table.deleteRow(0);
      }      
      
	  if (USE_PHP) {
	  
	  }else {
        xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = callbackGetData;
	    var requestMsg = 'index' + '?start=' + 0 + '&end=' + 0 + '&rnd=' + Math.random();
	    if (showSentMsg) showCommand(requestMsg);
        xmlhttp.open("GET", requestMsg, true);

        xmlhttp.send();
      }
    }else {
      showMessage('Invalid dates given!');
    }
  } 
  
function Funct_addCustomer() {
  alert('Not implemented ;\)');
}

function Funct_saveChanges() {
  alert('Not implemented ;\)');
}

function Funct_getCustomerInfo() {
    clearMessage();
    hideUserEditForm();
    showAddNewNewCustomer();
    var d = {status : true, startDate : 0, endDate : 0};
    
    if (d.status == true) {
      // clear customer data from table
      var table = document.getElementById('customerData');
      while (table.rows.length > 0) {
        table.deleteRow(0);
      }      
      
	  if (USE_PHP) {
	  
	  }else {
        xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = callbackGetData;
	    var requestMsg = 'customer' + '?name=' + '' + '&id=' + '' + '&rnd=' + Math.random();
        if (showSentMsg) showCommand(requestMsg);
        xmlhttp.open("GET", requestMsg, true);

        xmlhttp.send();
	  }
      collectData = true;
    }else {
      showMessage('Invalid dates given!');
    }
  }
  
function handleUserCell(){ return function(){
               var id = this.innerHTML;
               //alert(id);
               showUserEditForm(this.parentNode.cells);
               };}

function handleUser(){ return function(){
               var id = this.cells[3].innerHTML;
               //alert(id);
               showUserEditForm(this.cells);
               };}
               
function addRowHandlersToTable(tableId) {
  var i;
  var rows = document.getElementById(tableId).rows;
  for (i = 1; i < rows.length; i++) {
    rows[i].cells[2].onclick = function() { return handleUserCell();}(rows[i]);
    rows[i].cells[3].onclick = function() { return handleUserCell();}(rows[i]);
    rows[i].ondblclick = function() { return handleUser();}(rows[i]);
              
  }
}
/*    rows[i].ondblclick = function(){ return function(){
               var id = this.cells[3].innerHTML;
               //alert(id);
               showUserEditForm(this.cells);
               };}*/
var wakeupCount = 0;

function wakeupFunction() {
  xmlhttp = new XMLHttpRequest();
  xmlhttp.onreadystatechange = wakeupCallback;
  var requestMsg = 'wakeup' + '?rnd=' + Math.random();
  xmlhttp.open("GET", requestMsg, true);
  xmlhttp.send();

  wakeupServer();
}

function wakeupCallback() {
  if (xmlhttp.readyState == 4) {
    if(xmlhttp.status == 200) {
      var data = JSON.parse(xmlhttp.responseText);
      showCommand('--- WAKEUP ---' + wakeupCount++ + '---');
    }
  }
} 
  
function wakeupServer() {
  setTimeout( wakeupFunction, 10.0 * 600000.0);
}
</script>

</body>

</html>


